using Microsoft.EntityFrameworkCore;
using SWAPI_AR.Business.Interfaces;
using SWAPI_AR.Domain.Entities;
using SWAPI_AR.Repository.Data;
using SWAPI_AR.Repository.Repositories.Interfaces;

namespace SWAPI_AR.Business.Services
{
    public class StarshipService : IStarshipService
    {
        private readonly IStarshipRepository _starshipRepo;

        public StarshipService(IStarshipRepository starshipRepository)
        {
            _starshipRepo = starshipRepository;
        }

        public async Task<IEnumerable<Starship>> GetAllStarshipsAsync()
        {
            var starships = await _starshipRepo.GetAllStarshipsAsync();
            return starships;
        }

        public async Task<Starship?> GetStarshipByIdAsync(int id)
        {
            var starship = await _starshipRepo.GetStarshipByIdAsync(id);
            return starship;
        }

        public async Task<Starship> AddStarshipAsync(Starship starship)
        {
            var createdStarship = await _starshipRepo.AddStarshipAsync(starship);
            return createdStarship;
        }

        public async Task<Starship> UpdateStarshipAsync(int id, Starship starship)
        {
            var existing = await _starshipRepo.GetStarshipByIdAsync(id);
            if (existing == null)
            {
                // No existing starship to update.
                // TODO: Handle notifaction to caller when no exisiting starship found
                return null!;
            }
            // Map fields to existing starship
            existing.Name = starship.Name;
            existing.Model = starship.Model;
            existing.Manufacturer = starship.Manufacturer;
            existing.CostInCredits = starship.CostInCredits;
            existing.Length = starship.Length;
            existing.MaxAtmospheringSpeed = starship.MaxAtmospheringSpeed;
            existing.Crew = starship.Crew;
            existing.Passengers = starship.Passengers;
            existing.CargoCapacity = starship.CargoCapacity;
            existing.Consumables = starship.Consumables;
            existing.HyperdriveRating = starship.HyperdriveRating;
            existing.MGLT = starship.MGLT;
            existing.StarshipClass = starship.StarshipClass;
            existing.Pilots = starship.Pilots;
            existing.Films = starship.Films;
            existing.Edited = DateTime.UtcNow;

            var updatedStarship = await _starshipRepo.UpdateStarshipAsync(existing);
            return updatedStarship;
        }

        public async Task DeleteStarshipAsync(int id)
        {
            await _starshipRepo.DeleteStarshipAsync(id);
        }
    }
}
